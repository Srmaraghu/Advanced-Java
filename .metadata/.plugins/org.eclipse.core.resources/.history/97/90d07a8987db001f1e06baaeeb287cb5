package in.sp.backend;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@WebServlet("/register") // Define the endpoint for form submission
public class RegisterServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String email = request.getParameter("email");
        String password = request.getParameter("password");

        response.setContentType("text/plain");
        PrintWriter out = response.getWriter();

        try {
            // Database connection
            Class.forName("com.mysql.cj.jdbc.Driver"); // Ensure MySQL driver is added to your project
            Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/your_database", "username", "password");

            // Check if the user already exists
            String checkQuery = "SELECT * FROM users WHERE email = ?";
            PreparedStatement checkStmt = conn.prepareStatement(checkQuery);
            checkStmt.setString(1, email);
            ResultSet rs = checkStmt.executeQuery();

            if (rs.next()) {
                // User already exists
                out.println("User already exists!");
            } else {
            	import java.io.IOException;
            	import java.io.PrintWriter;
            	import java.sql.Connection;
            	import java.sql.DriverManager;
            	import java.sql.PreparedStatement;
            	import java.sql.ResultSet;

            	import jakarta.servlet.ServletException;
            	import jakarta.servlet.annotation.WebServlet;
            	import jakarta.servlet.http.HttpServlet;
            	import jakarta.servlet.http.HttpServletRequest;
            	import jakarta.servlet.http.HttpServletResponse;

            	@WebServlet("/register") // Define the endpoint for form submission
            	public class RegisterServlet extends HttpServlet {
            	    private static final long serialVersionUID = 1L;

            	    @Override
            	    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            	            throws ServletException, IOException {
            	        String email = request.getParameter("email");
            	        String password = request.getParameter("password");

            	        response.setContentType("text/plain");
            	        PrintWriter out = response.getWriter();

            	        try {
            	            // Database connection
            	            Class.forName("com.mysql.cj.jdbc.Driver"); // Ensure MySQL driver is added to your project
            	            Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/your_database", "username", "password");

            	            // Check if the user already exists
            	            String checkQuery = "SELECT * FROM users WHERE email = ?";
            	            PreparedStatement checkStmt = conn.prepareStatement(checkQuery);
            	            checkStmt.setString(1, email);
            	            ResultSet rs = checkStmt.executeQuery();

            	            if (rs.next()) {
            	                // User already exists
            	                out.println("User already exists!");
            	            } else {
            	                // Register the user
            	                String insertQuery = "INSERT INTO users (email, password) VALUES (?, ?)";
            	                PreparedStatement insertStmt = conn.prepareStatement(insertQuery);
            	                insertStmt.setString(1, email);
            	                insertStmt.setString(2, password);
            	                int rows = insertStmt.executeUpdate();

            	                if (rows > 0) {
            	                    out.println("User registered successfully!");
            	                } else {
            	                    out.println("Failed to register the user. Please try again.");
            	                }
            	            }

            	            // Close connections
            	            rs.close();
            	            checkStmt.close();
            	            conn.close();
            	        } catch (Exception e) {
            	            e.printStackTrace();
            	            out.println("An error occurred. Please try again later.");
            	        }
            	    }
            	}
                // Register the user
                String insertQuery = "INSERT INTO users (email, password) VALUES (?, ?)";
                PreparedStatement insertStmt = conn.prepareStatement(insertQuery);
                insertStmt.setString(1, email);
                insertStmt.setString(2, password);
                int rows = insertStmt.executeUpdate();

                if (rows > 0) {
                    out.println("User registered successfully!");
                } else {
                    out.println("Failed to register the user. Please try again.");
                }
            }

            // Close connections
            rs.close();
            checkStmt.close();
            conn.close();
        } catch (Exception e) {
            e.printStackTrace();
            out.println("An error occurred. Please try again later.");
        }
    }
}
